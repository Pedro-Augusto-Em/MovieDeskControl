-- ========================================
-- SCHEMA DE AUTENTICAÇÃO - ANYDESK CONTROL
-- ========================================

-- Tabela de usuários com autenticação
CREATE TABLE USERS (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR(50) UNIQUE NOT NULL,
    EMAIL VARCHAR(100) UNIQUE NOT NULL,
    PASSWORD_HASH VARCHAR(255) NOT NULL,
    PASSWORD_SALT VARCHAR(100) NOT NULL,
    FIRST_NAME VARCHAR(50),
    LAST_NAME VARCHAR(50),
    ROLE VARCHAR(30) DEFAULT 'USER',
    AVATAR BLOB SUB_TYPE TEXT,
    IS_ACTIVE BOOLEAN DEFAULT TRUE,
    IS_EMAIL_VERIFIED BOOLEAN DEFAULT FALSE,
    EMAIL_VERIFICATION_TOKEN VARCHAR(100),
    EMAIL_VERIFICATION_EXPIRES TIMESTAMP,
    PASSWORD_RESET_TOKEN VARCHAR(100),
    PASSWORD_RESET_EXPIRES TIMESTAMP,
    LAST_LOGIN TIMESTAMP,
    LOGIN_ATTEMPTS INTEGER DEFAULT 0,
    LOCKED_UNTIL TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabela de sessões ativas
CREATE TABLE USER_SESSIONS (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID INTEGER NOT NULL,
    SESSION_TOKEN VARCHAR(255) UNIQUE NOT NULL,
    IP_ADDRESS VARCHAR(45),
    USER_AGENT TEXT,
    EXPIRES_AT TIMESTAMP NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

-- Tabela de logs de autenticação
CREATE TABLE AUTH_LOGS (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID INTEGER,
    ACTION VARCHAR(50) NOT NULL,
    IP_ADDRESS VARCHAR(45),
    USER_AGENT TEXT,
    SUCCESS BOOLEAN DEFAULT FALSE,
    ERROR_MESSAGE TEXT,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE SET NULL
);

-- Tabela de configurações de segurança
CREATE TABLE SECURITY_SETTINGS (
    ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SETTING_KEY VARCHAR(100) UNIQUE NOT NULL,
    SETTING_VALUE TEXT,
    DESCRIPTION TEXT,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Índices para performance
CREATE INDEX IDX_USERS_EMAIL ON USERS(EMAIL);
CREATE INDEX IDX_USERS_USERNAME ON USERS(USERNAME);
CREATE INDEX IDX_USERS_VERIFICATION_TOKEN ON USERS(EMAIL_VERIFICATION_TOKEN);
CREATE INDEX IDX_USERS_RESET_TOKEN ON USERS(PASSWORD_RESET_TOKEN);
CREATE INDEX IDX_SESSIONS_TOKEN ON USER_SESSIONS(SESSION_TOKEN);
CREATE INDEX IDX_SESSIONS_USER ON USER_SESSIONS(USER_ID);
CREATE INDEX IDX_AUTH_LOGS_USER ON AUTH_LOGS(USER_ID);
CREATE INDEX IDX_AUTH_LOGS_ACTION ON AUTH_LOGS(ACTION);

-- Triggers para atualização automática
CREATE TRIGGER TR_USERS_UPDATE_TIMESTAMP
    ACTIVE BEFORE UPDATE ON USERS
    AS
BEGIN
    NEW.UPDATED_AT = CURRENT_TIMESTAMP;
END;

CREATE TRIGGER TR_SECURITY_SETTINGS_UPDATE_TIMESTAMP
    ACTIVE BEFORE UPDATE ON SECURITY_SETTINGS
    AS
BEGIN
    NEW.UPDATED_AT = CURRENT_TIMESTAMP;
END;

-- Inserir configurações de segurança padrão
INSERT INTO SECURITY_SETTINGS (SETTING_KEY, SETTING_VALUE, DESCRIPTION) VALUES
('PASSWORD_MIN_LENGTH', '8', 'Tamanho mínimo da senha'),
('PASSWORD_REQUIRE_UPPERCASE', 'true', 'Senha deve conter maiúscula'),
('PASSWORD_REQUIRE_LOWERCASE', 'true', 'Senha deve conter minúscula'),
('PASSWORD_REQUIRE_NUMBERS', 'true', 'Senha deve conter números'),
('PASSWORD_REQUIRE_SPECIAL', 'true', 'Senha deve conter caracteres especiais'),
('MAX_LOGIN_ATTEMPTS', '5', 'Máximo de tentativas de login'),
('LOCKOUT_DURATION_MINUTES', '30', 'Duração do bloqueio em minutos'),
('SESSION_TIMEOUT_HOURS', '24', 'Timeout da sessão em horas'),
('EMAIL_VERIFICATION_EXPIRES_HOURS', '24', 'Expiração do token de verificação'),
('PASSWORD_RESET_EXPIRES_HOURS', '1', 'Expiração do token de reset');

-- Inserir usuário administrador padrão
-- Senha: Admin@123 (hash bcrypt)
INSERT INTO USERS (USERNAME, EMAIL, PASSWORD_HASH, PASSWORD_SALT, FIRST_NAME, LAST_NAME, ROLE, IS_ACTIVE, IS_EMAIL_VERIFIED) VALUES
('admin', 'admin@anydeskcontrol.com', '$2b$10$rQZ8K9vX2mN3pL4qR5sT6uV7wX8yZ9aA0bB1cC2dD3eE4fF5gG6hH7iI8jJ9kK0lL1mM2nN3oO4pP5qQ6rR7sS8tT9uU0vV1wW2xX3yY4zZ', 'salt_admin_123', 'Administrador', 'Sistema', 'ADMIN', TRUE, TRUE);

-- Comentários das tabelas
COMMENT ON TABLE USERS IS 'Tabela de usuários com autenticação completa';
COMMENT ON TABLE USER_SESSIONS IS 'Sessões ativas dos usuários';
COMMENT ON TABLE AUTH_LOGS IS 'Logs de atividades de autenticação';
COMMENT ON TABLE SECURITY_SETTINGS IS 'Configurações de segurança do sistema';

-- Permissões
GRANT ALL ON USERS TO SYSDBA;
GRANT ALL ON USER_SESSIONS TO SYSDBA;
GRANT ALL ON AUTH_LOGS TO SYSDBA;
GRANT ALL ON SECURITY_SETTINGS TO SYSDBA;
